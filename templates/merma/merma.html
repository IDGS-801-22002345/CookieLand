{% extends "layout.html" %}
{% block content %}
{% import "_macros.html" as macros %}
<script src="{{ url_for('static', filename='js/merma.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<title>Merma</title>

<!-- Contenedor principal con margen superior -->
<div class="flex flex-col w-full px-10">
    
    <!-- Botón para abrir el modal de agregar -->
    <div class="w-full p-4 text-center border border-gray-300 rounded-lg shadow-sm">
        <div class="flex justify-between pb-5">
            <div>
                <h1 class="text-4xl font-medium text-gray-800">Merma</h1>
            </div>
            <button data-modal-target="crud-modal" data-modal-toggle="crud-modal"
                class="flex items-center gap-2 text-white focus:outline-none bg-green-500 hover:bg-green-500 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-1 dark:bg-green-600 dark:hover:bg-[#3b82f6]">
                <i class="fas fa-boxes"></i> <i class="fas fa-arrow-down text-xs"></i> 
                Agregar Merma
            </button>
        </div>
        
        <div class="flex items-center border border-gray-300 rounded-md w-96 p-2">
            <i class="fas fa-search text-gray-500 px-2"></i>
            <input type="search" id="search-input" class="w-full outline-none" placeholder="Buscar merma por descripción, nombre o tipo"/>
        </div>

        <!-- Contenedor de la tabla con scroll -->
        <div class="overflow-x-auto overflow-y-auto max-h-[500px] mt-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <table id="mermas-table" class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-white uppercase sticky top-0" style="background-color: #7c5454; z-index: 10;">
                    <tr>
                        <th scope="col" class="px-6 py-3">Descripción</th>
                        <th scope="col" class="px-6 py-3">Cantidad</th>
                        <th scope="col" class="px-6 py-3">Fecha y Hora</th>
                        <th scope="col" class="px-6 py-3">Nombre</th>
                        <th scope="col" class="px-6 py-3">Tipo Merma</th>
                    </tr>
                </thead>
                <tbody id="mermas-body">
                    {% if mermas %}  
                        {% for merma in mermas %}
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 border-gray-200 relative">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                                {{ merma.descripcion }}
                            </th>
                            <td class="px-6 py-4">{{ merma.cantidad }}</td>
                            <td class="px-6 py-4">{{ merma.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td class="px-6 py-4">
                                {% if merma.tipo_merma == 'insumo' and merma.inventario_materia %}
                                    {{ merma.inventario_materia.materia_prima.nombre }}
                                {% elif merma.tipo_merma == 'galleta' and merma.galleta %}
                                    {{ merma.galleta.nombre }}
                                {% else %}
                                    Sin nombre
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">{{ merma.tipo_merma }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}  
                        <tr>
                            <td colspan="5" class="text-center py-8 bg-gray-50 rounded-lg">
                                <i class="fas fa-info-circle text-gray-400 text-4xl mb-3"></i>
                                <p class="text-gray-500">No hay mermas registradas aún</p>
                                <p class="text-sm text-gray-400 mt-1">
                                    Agregue mermas usando el formulario
                                </p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
                <tbody id="no-results" style="display: none;">
                    <tr>
                        <td colspan="5" class="text-center py-8 bg-gray-50 rounded-lg">
                            <i class="fas fa-search-minus text-gray-400 text-4xl mb-3"></i>
                            <p class="text-gray-500">No se encontraron mermas</p>
                            <p class="text-sm text-gray-400 mt-1">
                                No hay coincidencias con tu búsqueda
                            </p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("search-input");
    const table = document.getElementById("mermas-table");
    const mermasBody = document.getElementById("mermas-body");
    const noResults = document.getElementById("no-results");
    
    searchInput.addEventListener("input", function () {
        const searchText = this.value.toLowerCase();
        const rows = mermasBody.getElementsByTagName("tr"); 
        let hasResults = false;

        Array.from(rows).forEach(row => {
            const cells = row.querySelectorAll("th, td"); 
            let rowMatches = false;

            cells.forEach(cell => {
                const cellText = cell.textContent.toLowerCase();
                if (cellText.includes(searchText)) {
                    rowMatches = true;
                }
            });

            if (rowMatches) {
                row.style.display = "";
                hasResults = true;
            } else {
                row.style.display = "none";
            }
        });

        if (!hasResults && searchText.length > 0) {
            noResults.style.display = "";
            mermasBody.style.display = "none";
        } else {
            noResults.style.display = "none";
            mermasBody.style.display = "";
        }
    });
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
{% endblock %}